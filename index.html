<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MNP乗り換えタイミングチェック</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'mnp-ready': '#10B981',    // 今すぐOK（緑）
                        'mnp-soon': '#F59E0B',     // 30日以内OK（黄色）
                        'mnp-waiting': '#3B82F6'   // 待機中（青）
                    }
                }
            }
        }
    </script>
    <style>
        .status-ready { color: #10B981; }
        .status-soon { color: #F59E0B; }
        .status-waiting { color: #3B82F6; }
        /* カスタムセレクトボックス */
        .custom-select {
            position: relative;
        }
        .custom-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            min-height: 40px;
            font-size: 16px;
        }
        .custom-select-trigger:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 6px 6px;
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .custom-select-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
        }
        .custom-select-option:hover {
            background: #f3f4f6;
        }
        .custom-select-option:last-child {
            border-radius: 0 0 6px 6px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // データ型定義（TypeScriptの代わりにコメントで）
        /*
        interface MNPLine {
            id: string;
            phoneNumber: string;
            carrier: string;
            customCarrier?: string;
            contractDate?: string;
            nextMNPDate?: string;
            customNextMNPDate?: string;
            mnpReservationNumber?: string;
            reservationExpiry?: string;
            loginId?: string;
            loginPassword?: string;
            memo?: string;
            createdAt: string;
            updatedAt: string;
        }
        */

        // ユーティリティ関数
        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        };

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        };

        // 曜日を含む日付フォーマット
        const formatDateWithWeekday = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            const weekday = weekdays[date.getDay()];
            return `${formatDate(dateString)}(${weekday})`;
        };

        const calculateNextMNPDate = (contractDate) => {
            if (!contractDate) return null;
            const date = new Date(contractDate);
            date.setDate(date.getDate() + 180);
            return date.toISOString().split('T')[0];
        };

        const getStatusInfo = (nextMNPDate) => {
            if (!nextMNPDate) return { status: 'unknown', text: '未設定', class: 'text-gray-500' };
            
            const today = new Date();
            const mnpDate = new Date(nextMNPDate);
            const diffTime = mnpDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays <= 0) {
                return { status: 'ready', text: '今すぐOK', class: 'status-ready' };
            } else if (diffDays <= 30) {
                return { status: 'soon', text: `${diffDays}日後OK`, class: 'status-soon' };
            } else {
                return { status: 'waiting', text: '待機中', class: 'status-waiting' };
            }
        };

        const getCarrierColor = (carrier) => {
            const colors = {
                'docomo': 'bg-blue-100 text-blue-800',
                'au': 'bg-orange-100 text-orange-800',
                'softbank': 'bg-yellow-100 text-yellow-800',
                'rakuten': 'bg-pink-100 text-red-800',
                'uq mobile': 'bg-green-100 text-green-800',
                'y!mobile': 'bg-red-100 text-pink-800',
                'その他': 'bg-gray-100 text-gray-800'
            };
            return colors[carrier.toLowerCase()] || colors['その他'];
        };

        // ローカルストレージ操作
        const STORAGE_KEY = 'mnp_lines';

        const saveToStorage = (lines) => {
            try {
                const dataWithMeta = {
                    version: '1.0',
                    data: lines,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataWithMeta));
            } catch (error) {
                console.error('データの保存に失敗しました:', error);
            }
        };

        const loadFromStorage = () => {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    // バージョン管理対応
                    if (parsed.data) {
                        return parsed.data;
                    }
                    // 旧形式の場合は直接返す
                    return Array.isArray(parsed) ? parsed : [];
                }
                return [];
            } catch (error) {
                console.error('データの読み込みに失敗しました:', error);
                return [];
            }
        };
        // カスタムセレクトボックスコンポーネント
        const CustomSelect = ({ value, onChange, options, placeholder, className, error }) => {
            const [isOpen, setIsOpen] = useState(false);
            const selectRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (selectRef.current && !selectRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };

                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const handleSelect = (optionValue) => {
                onChange(optionValue);
                setIsOpen(false);
            };

            const selectedOption = options.find(opt => opt.value === value);

            return (
                <div className={`custom-select ${className}`} ref={selectRef}>
                    <div 
                        className={`custom-select-trigger ${error ? 'border-red-300' : 'border-gray-300'} ${isOpen ? 'border-blue-500' : ''}`}
                        onClick={() => setIsOpen(!isOpen)}
                        tabIndex={0}
                        onKeyDown={(e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                setIsOpen(!isOpen);
                            }
                        }}
                    >
                        <span className={selectedOption ? 'text-gray-900' : 'text-gray-500'}>
                            {selectedOption ? selectedOption.label : placeholder}
                        </span>
                        <svg className={`w-4 h-4 text-gray-400 transform transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    {isOpen && (
                        <div className="custom-select-options">
                            {options.map((option) => (
                                <div
                                    key={option.value}
                                    className="custom-select-option"
                                    onClick={() => handleSelect(option.value)}
                                >
                                    {option.label}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };
        // メインのApp コンポーネント
        const App = () => {
            const [lines, setLines] = useState([]);
            const [showAddForm, setShowAddForm] = useState(false);
            const [editingLine, setEditingLine] = useState(null);
            const [viewMode, setViewMode] = useState('card'); // 'card' | 'table'
            const [searchTerm, setSearchTerm] = useState('');
            const [filterCarrier, setFilterCarrier] = useState('all');
            const [filterStatus, setFilterStatus] = useState('all');

            // 初回読み込み
            useEffect(() => {
                const loadedLines = loadFromStorage();
                setLines(loadedLines);
            }, []);

            // データが変更された時の保存
            useEffect(() => {
                saveToStorage(lines);
            }, [lines]);

            // 回線の追加
            const addLine = (lineData) => {
                const newLine = {
                    ...lineData,
                    id: generateId(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                };

                // 契約日が設定されている場合、次回MNP可能日を自動計算
                if (newLine.contractDate && !newLine.customNextMNPDate) {
                    newLine.nextMNPDate = calculateNextMNPDate(newLine.contractDate);
                }

                setLines(prev => [...prev, newLine]);
                setShowAddForm(false);
            };

            // 回線の更新
            const updateLine = (id, updates) => {
                setLines(prev => prev.map(line => {
                    if (line.id === id) {
                        const updatedLine = {
                            ...line,
                            ...updates,
                            updatedAt: new Date().toISOString()
                        };
                        // キャリアが「その他」以外に変更された場合、customCarrierをクリア
                        if (updates.carrier && updates.carrier !== 'その他') {
                            updatedLine.customCarrier = '';
                        }

                        // 契約日が変更された場合、次回MNP可能日を再計算
                        if (updates.contractDate && !updates.customNextMNPDate) {
                            updatedLine.nextMNPDate = calculateNextMNPDate(updates.contractDate);
                        }

                        return updatedLine;
                    }
                    return line;
                }));
                setEditingLine(null);
            };

            // 回線の削除
            const deleteLine = (id) => {
                if (window.confirm('この回線を削除してもよろしいですか？')) {
                    setLines(prev => prev.filter(line => line.id !== id));
                }
            };

            // フィルタリングされた回線データ
            const filteredLines = lines.filter(line => {
                // 検索条件
                const matchesSearch = !searchTerm || 
                    line.phoneNumber.includes(searchTerm) ||
                    (line.customCarrier || line.carrier).toLowerCase().includes(searchTerm.toLowerCase());

                // キャリア条件
                const matchesCarrier = filterCarrier === 'all' || 
                    (line.customCarrier || line.carrier).toLowerCase() === filterCarrier.toLowerCase();

                // ステータス条件
                let matchesStatus = true;
                if (filterStatus !== 'all') {
                    const statusInfo = getStatusInfo(line.nextMNPDate);
                    matchesStatus = statusInfo.status === filterStatus;
                }

                return matchesSearch && matchesCarrier && matchesStatus;
            });

            // 統計データ
            const stats = {
                total: lines.length,
                ready: lines.filter(line => getStatusInfo(line.nextMNPDate).status === 'ready').length,
                soon: lines.filter(line => getStatusInfo(line.nextMNPDate).status === 'soon').length,
                waiting: lines.filter(line => getStatusInfo(line.nextMNPDate).status === 'waiting').length
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="max-w-6xl mx-auto">
                    {/* ヘッダー */}
                    <Header />

                    {/* サマリーカード */}
                    <SummaryCards stats={stats} />

                    {/* ツールバー */}
                    <Toolbar
                        searchTerm={searchTerm}
                        setSearchTerm={setSearchTerm}
                        filterCarrier={filterCarrier}
                        setFilterCarrier={setFilterCarrier}
                        filterStatus={filterStatus}
                        setFilterStatus={setFilterStatus}
                        onAddClick={() => setShowAddForm(true)}
                        lines={lines}
                        setLines={setLines}
                    />

                    {/* 回線リスト */}
                    <LineList
                        lines={filteredLines}
                        onEdit={setEditingLine}
                        onDelete={deleteLine}
                        showAddForm={showAddForm}
                        editingLine={editingLine}
                    />

                    {/* 新規追加フォーム */}
                    {showAddForm && (
                        <LineForm
                            onSave={addLine}
                            onCancel={() => setShowAddForm(false)}
                        />
                    )}

                    {/* 編集フォーム */}
                    {editingLine && (
                        <LineForm
                            initialData={editingLine}
                            onSave={(data) => updateLine(editingLine.id, data)}
                            onCancel={() => setEditingLine(null)}
                            onDelete={() => deleteLine(editingLine.id)}
                            isEditing={true}
                        />
                    )}

                    {/* フローティングアクションボタン（モバイル用） */}
                    {!showAddForm && !editingLine && (
                        <button
                            onClick={() => setShowAddForm(true)}
                            className="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-lg z-50 md:hidden"
                            aria-label="新規回線追加"
                        >
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    )}
                    </div>
                </div>
            );
        };

        // ヘッダーコンポーネント
        const Header = () => {
            return (
                <header className="bg-white shadow-sm border-b">
                    <div className="px-4 py-3">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <h1 className="text-xl font-bold text-gray-900">MNP乗り換えタイミングチェック</h1>
                            </div>
                        </div>
                    </div>
                </header>
            );
        };

        // サマリーカードコンポーネント
        const SummaryCards = ({ stats }) => {
            return (
                <div className="px-4 py-4 bg-white border-b">
                    <div className="grid grid-cols-4 gap-3">
                        <div className="text-center">
                            <div className="text-2xl font-bold text-gray-900">{stats.total}</div>
                            <div className="text-xs text-gray-500">総数</div>
                        </div>
                        <div className="text-center">
                            <div className="text-2xl font-bold status-ready">{stats.ready}</div>
                            <div className="text-xs text-gray-500">今すぐOK</div>
                        </div>
                        <div className="text-center">
                            <div className="text-2xl font-bold status-soon">{stats.soon}</div>
                            <div className="text-xs text-gray-500">30日以内OK</div>
                        </div>
                        <div className="text-center">
                            <div className="text-2xl font-bold status-waiting">{stats.waiting}</div>
                            <div className="text-xs text-gray-500">待機中</div>
                        </div>
                    </div>
                </div>
            );
        };
        // ツールバーコンポーネント
        const Toolbar = ({ searchTerm, setSearchTerm, filterCarrier, setFilterCarrier, filterStatus, setFilterStatus, onAddClick, lines, setLines }) => {
            const [showFilters, setShowFilters] = useState(false);

            const carriers = ['docomo', 'au', 'softbank', 'rakuten', 'UQ mobile', 'Y!mobile', 'その他'];

            // CSVエクスポート
            const exportCSV = () => {
                if (lines.length === 0) {
                    alert('エクスポートするデータがありません');
                    return;
                }

                const headers = ['電話番号', 'キャリア', '契約日', '次回MNP可能日', 'MNP予約番号', '予約番号有効期限', 'ログインID', 'パスワード', 'メモ'];
                
                const csvData = lines.map(line => [
                    line.phoneNumber,
                    line.customCarrier || line.carrier,
                    line.contractDate || '',
                    line.nextMNPDate || '',
                    line.mnpReservationNumber || '',
                    line.reservationExpiry || '',
                    line.loginId || '',
                    line.loginPassword || '',
                    line.memo || ''
                ]);

                const csvContent = [headers, ...csvData]
                    .map(row => row.map(cell => `"${cell}"`).join(','))
                    .join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `mnp_lines_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            };

            // CSVインポート
            const importCSV = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const rows = text.split('\n').filter(row => row.trim());
                        
                        if (rows.length < 2) {
                            alert('有効なデータが見つかりません');
                            return;
                        }

                        const dataRows = rows.slice(1); // ヘッダーを除く
                        const importedLines = [];

                        dataRows.forEach(row => {
                            const cells = row.split(',').map(cell => cell.replace(/"/g, '').trim());
                            if (cells.length >= 2 && cells[0] && cells[1]) {
                                const newLine = {
                                    id: generateId(),
                                    phoneNumber: cells[0],
                                    carrier: cells[1],
                                    contractDate: cells[2] || '',
                                    nextMNPDate: cells[3] || '',
                                    mnpReservationNumber: cells[4] || '',
                                    reservationExpiry: cells[5] || '',
                                    loginId: cells[6] || '',
                                    loginPassword: cells[7] || '',
                                    memo: cells[8] || '',
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                };

                                // 次回MNP日が設定されていない場合は自動計算
                                if (newLine.contractDate && !newLine.nextMNPDate) {
                                    newLine.nextMNPDate = calculateNextMNPDate(newLine.contractDate);
                                }

                                importedLines.push(newLine);
                            }
                        });

                        if (importedLines.length > 0) {
                            setLines(prev => [...prev, ...importedLines]);
                            alert(`${importedLines.length}件のデータをインポートしました`);
                        } else {
                            alert('インポート可能なデータが見つかりませんでした');
                        }
                    } catch (error) {
                        alert('CSVファイルの読み込みに失敗しました');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // ファイル選択をリセット
            };

            return (
                <div className="bg-white border-b">
                    <div className="px-4 py-3">
                        {/* メインツールバー */}
                        <div className="flex items-center justify-between mb-3">
                            <button
                                onClick={onAddClick}
                                className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium hidden md:flex items-center gap-2">
                                新規追加
                            </button>
                            
                            {/* モバイル用のスペーサー */}
                            <div className="md:hidden"></div>
                            
                            <div className="flex items-center space-x-2">
                                <button
                                    onClick={exportCSV}
                                    className="flex items-center gap-1 px-2 py-2 text-xs text-white bg-blue-600 hover:bg-blue-700 rounded-lg font-medium whitespace-nowrap" title="CSVエクスポート">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                                    </svg>
                                    エクスポート
                                </button>                           
                                <label className="flex items-center gap-1 px-2 py-2 text-xs text-white bg-blue-600 hover:bg-blue-700 rounded-lg font-medium cursor-pointer whitespace-nowrap" title="CSVインポート">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    インポート
                                    <input
                                        type="file"
                                        accept=".csv"
                                        onChange={importCSV}
                                        className="hidden"
                                    />
                                </label>
                                
                                <button
                                    onClick={() => setShowFilters(!showFilters)}
                                    className={`flex items-center gap-1 px-2 py-2 text-xs rounded-lg font-medium whitespace-nowrap ${showFilters ? 'bg-gray-200 text-gray-800' : 'text-gray-600 bg-gray-100 hover:bg-gray-200'}`}
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                    </svg>
                                    絞り込み
                                </button>
                            </div>
                        </div>

                        {/* 検索・フィルター */}
                        {showFilters && (
                            <div className="space-y-3">
                                {/* 検索 */}
                                <div>
                                    <input
                                        type="text"
                                        placeholder="電話番号・キャリアで検索"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>

                                {/* フィルター */}
                                <div className="flex space-x-2">
                                    <select
                                        value={filterCarrier}
                                        onChange={(e) => setFilterCarrier(e.target.value)}
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="all">すべてのキャリア</option>
                                        {carriers.map(carrier => (
                                            <option key={carrier} value={carrier}>{carrier}</option>
                                        ))}
                                    </select>

                                    <select
                                        value={filterStatus}
                                        onChange={(e) => setFilterStatus(e.target.value)}
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="all">すべてのステータス</option>
                                        <option value="ready">今すぐOK</option>
                                        <option value="soon">30日以内OK</option>
                                        <option value="waiting">待機中</option>
                                    </select>
                                </div>

                                {/* フィルターリセット */}
                                {(searchTerm || filterCarrier !== 'all' || filterStatus !== 'all') && (
                                    <div className="flex justify-end">
                                        <button
                                            onClick={() => {
                                                setSearchTerm('');
                                                setFilterCarrier('all');
                                                setFilterStatus('all');
                                            }}
                                            className="text-sm text-gray-500 hover:text-gray-700"
                                        >
                                            🗑️ 絞り込み条件をクリア
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 回線リストコンポーネント
        const LineList = ({ lines, onEdit, onDelete, showAddForm, editingLine }) => {
            if (lines.length === 0) {
                return (
                    <div className="px-4 py-8 pb-32 md:pb-8 text-center text-gray-500">
                        <div className="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                            <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                            </svg>
                        </div>
                        <p className="text-lg font-medium">回線が登録されていません</p>
                        <p className="text-sm hidden md:block">「新規追加」ボタンから最初の回線を登録してください</p>
                        <p className="text-sm md:hidden">＋ボタンをタップして最初の回線を登録してください</p>
                    </div>
                );
            }

            return (
                <div className="px-4 py-2 pb-32 md:pb-8 space-y-3">
                    {lines.map(line => (
                        <LineCard
                            key={line.id}
                            line={line}
                            onEdit={() => onEdit(line)}
                            onDelete={() => onDelete(line.id)}
                        />
                    ))}
                </div>
            );
        };
        // 回線カードコンポーネント
        const LineCard = ({ line, onEdit, onDelete }) => {
            const statusInfo = getStatusInfo(line.nextMNPDate);
            const carrierColorClass = getCarrierColor(line.customCarrier || line.carrier);

            return (
                <div className="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
                    {/* ヘッダー部分 */}
                    <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center space-x-2">
                            <span className="text-lg font-medium text-gray-900">{line.phoneNumber}</span>
                            <span className={`px-2 py-1 rounded-full text-sm font-medium ${carrierColorClass}`}>
                                {line.customCarrier || line.carrier}
                            </span>
                        </div>
                        
                        {/* ステータス（右） */}
                        <div className={`px-3 py-2 rounded-lg border-2 text-sm font-bold ${
                            statusInfo.status === 'ready' ? 'border-mnp-ready bg-green-50 text-mnp-ready' :
                            statusInfo.status === 'soon' ? 'border-mnp-soon bg-yellow-50 text-mnp-soon' :
                            'border-mnp-waiting bg-blue-50 text-mnp-waiting'
                        }`}>
                            {statusInfo.text}
                        </div>
                    </div>

                    {/* キャリア情報と操作ボタンを同じ行に配置 */}
                    <div className="flex justify-end space-x-2 mb-3">
                        <div className="flex space-x-2">
                            <button
                                onClick={onEdit}
                                className="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium flex items-center gap-1"
                                title="編集"
                            >
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                編集
                            </button>
                            <button
                                onClick={onDelete}
                                className="px-3 py-1 text-sm bg-red-50 hover:bg-red-100 text-red-600 rounded-lg font-medium flex items-center gap-1"
                                title="削除"
                            >
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                削除
                            </button>
                        </div>
                    </div>

                    {/* 詳細情報 - レイアウト修正 */}
                    <div className="space-y-3 text-sm">
                        {/* 契約日と次回MNP可能日を横並び */}
                        {(line.contractDate || line.nextMNPDate) && (
                            <div>
                                <div className="flex flex-row space-x-2 text-sm">
                                    {line.contractDate && (
                                        <div className="flex-1">
                                            <span className="text-gray-600 text-sm block mb-1">📅 契約日</span>
                                            <span className="font-mono text-sm inline-block">{formatDateWithWeekday(line.contractDate)}</span>
                                        </div>
                                    )}
                                    {line.nextMNPDate && (
                                        <div className="flex-1">
                                            <span className="text-gray-600 text-sm block mb-1">🗓️ 次回MNP可能日</span>
                                            <span className="font-mono text-sm inline-block ">{formatDateWithWeekday(line.nextMNPDate)}</span>
                                        </div>
                                    )}
                                 </div>
                                <div className="border-t border-gray-100 mt-2"></div>
                            </div>
                        )}
                        
                        {line.mnpReservationNumber && (
                            <div className="py-1">
                                <span className="text-gray-600 text-sm block mb-1">🎫 MNP予約番号</span>
                                <span className="font-mono text-sm block">{line.mnpReservationNumber}</span>
                            </div>
                        )}
                        
                        {line.reservationExpiry && (
                            <div className="py-1">
                                <span className="text-gray-600 text-sm block mb-1">⏰ 予約番号有効期限</span>
                                <span className={`font-mono text-sm block ${new Date(line.reservationExpiry) < new Date() ? 'text-red-600' : ''}`}>
                                    {formatDateWithWeekday(line.reservationExpiry)}
                                </span>
                            </div>
                        )}
                        
                        {line.loginId && (
                            <div className="py-1">
                                <span className="text-gray-600 text-sm block mb-1">👤 ログインID</span>
                                <span className="font-sans text-sm break-all">{line.loginId}</span>
                            </div>
                        )}
                        
                        {line.memo && (
                            <div className="pt-3 border-t border-gray-100">
                                <span className="text-gray-600 text-sm block mb-2">📝 メモ</span>
                                <p className="text-gray-800 text-sm whitespace-pre-wrap word-break-normal leading-relaxed font-sans">{line.memo}</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 回線フォームコンポーネント
        const LineForm = ({ initialData, onSave, onCancel, onDelete, isEditing = false }) => {
            const [formData, setFormData] = useState({
                phoneNumber: initialData?.phoneNumber || '',
                carrier: initialData?.carrier || '',
                customCarrier: initialData?.customCarrier || '',
                contractDate: initialData?.contractDate || '',
                nextMNPDate: initialData?.nextMNPDate || '',
                customNextMNPDate: initialData?.customNextMNPDate || '',
                mnpReservationNumber: initialData?.mnpReservationNumber || '',
                reservationExpiry: initialData?.reservationExpiry || '',
                loginId: initialData?.loginId || '',
                loginPassword: initialData?.loginPassword || '',
                memo: initialData?.memo || ''
            });

            const [errors, setErrors] = useState({});
            const [showPassword, setShowPassword] = useState(false);

            const carriers = ['docomo', 'au', 'softbank', 'rakuten', 'UQ mobile', 'Y!mobile'];

            // バリデーション
            const validateForm = () => {
                const newErrors = {};

                // 必須項目チェック
                if (!formData.phoneNumber.trim()) {
                    newErrors.phoneNumber = '電話番号は必須です';
                } else if (!/^[\d-]+$/.test(formData.phoneNumber)) {
                    newErrors.phoneNumber = '電話番号の形式が正しくありません';
                }

                if (!formData.carrier.trim()) {
                    newErrors.carrier = 'キャリアは必須です';
                }

                // その他が選択された場合のカスタムキャリアチェック
                if (formData.carrier === 'その他' && !formData.customCarrier.trim()) {
                    newErrors.customCarrier = 'カスタムキャリア名は必須です';
                }

                // MNP予約番号のチェック
                // if (!formData.mnpReservationNumber.trim()) {
                //     newErrors.mnpReservationNumber = 'MNP予約番号は必須です';
                // }
                // if (formData.mnpReservationNumber && !/^\d{10}$/.test(formData.mnpReservationNumber.replace(/\D/g, ''))) {
                //     newErrors.mnpReservationNumber = 'MNP予約番号は10桁の数字で入力してください';
                // }

                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!validateForm()) return;

                const dataToSave = { ...formData };

                // 電話番号をフォーマット
                dataToSave.phoneNumber = formatPhoneNumber(formData.phoneNumber);

                // 契約日が設定されていて、カスタムMNP日が未設定の場合は自動計算
                if (dataToSave.contractDate && !dataToSave.customNextMNPDate) {
                    dataToSave.nextMNPDate = calculateNextMNPDate(dataToSave.contractDate);
                } else if (dataToSave.customNextMNPDate) {
                    dataToSave.nextMNPDate = dataToSave.customNextMNPDate;
                }

                onSave(dataToSave);
            };

            const handleReset = () => {
                setFormData({
                    phoneNumber: '',
                    carrier: '',
                    customCarrier: '',
                    contractDate: '',
                    nextMNPDate: '',
                    customNextMNPDate: '',
                    mnpReservationNumber: '',
                    reservationExpiry: '',
                    loginId: '',
                    loginPassword: '',
                    memo: ''
                });
                setErrors({});
            };

            const formatPhoneNumber = (phone) => {
                const cleaned = phone.replace(/\D/g, '');
                if (cleaned.length === 11) {
                    return `${cleaned.slice(0, 3)}-${cleaned.slice(3, 7)}-${cleaned.slice(7)}`;
                }
                return phone;
            };

            const handleChange = (field, value) => {
                const newFormData = { ...formData, [field]: value };
                // キャリアが「その他」以外に変更された場合、customCarrierをクリア
                if (field === 'carrier' && value !== 'その他') {
                    newFormData.customCarrier = '';
                }

                setFormData(prev => ({ ...prev, [field]: value }));
                // エラーをクリア
                if (errors[field]) {
                    setErrors(prev => ({ ...prev, [field]: '' }));
                }
            };

            const nextMNPDate = formData.customNextMNPDate || 
                (formData.contractDate ? calculateNextMNPDate(formData.contractDate) : null);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg w-full max-w-md" style={{ maxHeight: '90vh' }}>
                        {/* ヘッダー */}
                        <div className="flex items-center justify-between p-4 border-b border-gray-200">
                            <h2 className="text-xl font-semibold">
                                {isEditing ? '回線編集' : '新規回線追加'}
                            </h2>
                            <div className="flex items-center space-x-2">
                                {isEditing && (
                                    <button 
                                        onClick={() => {
                                                onDelete();
                                                onCancel();
                                            }
                                        }
                                        className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium flex items-center gap-2 whitespace-nowrap">
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                        削除
                                    </button>
                                )}
                                <button onClick={handleSubmit} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium whitespace-nowrap">
                                    💾 保存
                                </button>
                                <button onClick={onCancel} className="p-1 hover:bg-gray-100 rounded-lg text-gray-600 hover:text-gray-800">
                                    <i className="fas fa-times text-lg"></i>
                                </button>
                            </div>
                        </div>

                        {/* フォーム - スクロール可能にして高さ調整 */}
                        <div className="overflow-y-auto" style={{ maxHeight: 'calc(90vh - 80px)' }}>
                            <form onSubmit={handleSubmit} className="p-4 space-y-4">
                                {/* 基本情報 */}
                                <div className="space-y-4">
                                    <h3 className="font-medium text-gray-900 border-b pb-2">基本情報</h3>
                                    
                                    {/* 電話番号 */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            📱 電話番号 <span className="text-red-500">*</span>
                                        </label>
                                        <input
                                            type="tel"
                                            value={formData.phoneNumber}
                                            onChange={(e) => handleChange('phoneNumber', e.target.value)}
                                            placeholder="09012345678"
                                            className={`w-full px-3 py-2 border rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                                errors.phoneNumber ? 'border-red-300' : 'border-gray-300'
                                            }`}
                                            style={{ fontSize: '16px' }}
                                        />
                                        {errors.phoneNumber && (
                                            <p className="mt-1 text-xs text-red-600">{errors.phoneNumber}</p>
                                        )}
                                    </div>

                                    {/* キャリア */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            🏢 契約キャリア <span className="text-red-500">*</span>
                                        </label>
                                        <CustomSelect
                                            value={formData.carrier}
                                            onChange={(value) => handleChange('carrier', value)}
                                            options={carriers.map(carrier => ({ value: carrier, label: carrier }))}
                                            placeholder="キャリアを選択"
                                            error={errors.carrier}
                                        />
                                        {errors.carrier && (
                                            <p className="mt-1 text-xs text-red-600">{errors.carrier}</p>
                                        )}
                                    </div>

                                    {/* カスタムキャリア（その他選択時） */}
                                    {formData.carrier === 'その他' && (
                                        <div>
                                            <label className="block text-base font-medium text-gray-700 mb-1">
                                                ✏️ キャリア名入力 <span className="text-red-500">*</span>
                                            </label>
                                            <input
                                                type="text"
                                                value={formData.customCarrier}
                                                onChange={(e) => handleChange('customCarrier', e.target.value)}
                                                placeholder="例：mineo、IIJmio等"
                                                className={`w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                                    errors.customCarrier ? 'border-red-300' : 'border-gray-300'
                                                }`}
                                                style={{ fontSize: '16px' }}
                                            />
                                            {errors.customCarrier && (
                                                <p className="mt-1 text-xs text-red-600">{errors.customCarrier}</p>
                                            )}
                                        </div>
                                    )}

                                    {/* 契約日 */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            📅 契約日
                                        </label>
                                        <div className="relative">
                                            <input
                                                type="text"
                                                value={formData.contractDate ? formatDateWithWeekday(formData.contractDate) : ''}
                                                readOnly
                                                onClick={() => {
                                                    document.getElementById('contractDateHidden').focus();
                                                    document.getElementById('contractDateHidden').showPicker?.();
                                                }}
                                                placeholder="日付を選択してください"
                                                className="w-full px-3 py-2 pr-16 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent cursor-pointer bg-white"
                                                style={{ fontSize: '16px' }}
                                            />
                                            <input
                                                id="contractDateHidden"
                                                type="date"
                                                value={formData.contractDate}
                                                onChange={(e) => handleChange('contractDate', e.target.value)}
                                                className="absolute inset-0 opacity-0 pointer-events-none"
                                            />
                                            <div className="absolute right-8 top-3 pointer-events-none">
                                                <svg className="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 22 22">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                            </div>
                                            {formData.contractDate && (
                                                <button
                                                    type="button"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        handleChange('contractDate', '');
                                                    }}
                                                    className="absolute right-1 top-2.5 w-6 h-6 flex items-center justify-center text-gray-400 hover:text-red-600 hover:bg-red-50 rounded z-10"
                                                    title="クリア"
                                                >
                                                    <i className="fas fa-trash-alt text-xs"></i>
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* MNP関連情報 */}
                                <div className="space-y-4">
                                    <h3 className="font-medium text-gray-900 border-b pb-2">MNP関連情報</h3>
                                    
                                    {/* MNP予約番号 */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            🎫 MNP予約番号
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.mnpReservationNumber}
                                            onChange={(e) => handleChange('mnpReservationNumber', e.target.value)}
                                            placeholder="1234567890"
                                            className={`w-full px-3 py-2 border rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                                errors.mnpReservationNumber ? 'border-red-300' : 'border-gray-300'
                                            }`}
                                            style={{ fontSize: '16px' }}
                                        />
                                        {errors.mnpReservationNumber && (
                                            <p className="mt-1 text-xs text-red-600">{errors.mnpReservationNumber}</p>
                                        )}
                                    </div>

                                    {/* 予約番号有効期限 */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            ⏰ 予約番号有効期限
                                        </label>
                                        <div className="relative">
                                            <input
                                                type="text"
                                                value={formData.reservationExpiry ? formatDateWithWeekday(formData.reservationExpiry) : ''}
                                                readOnly
                                                onClick={() => {
                                                    document.getElementById('reservationExpiryHidden').focus();
                                                    document.getElementById('reservationExpiryHidden').showPicker?.();
                                                }}
                                                placeholder="日付を選択してください"
                                                className="w-full px-3 py-2 pr-16 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent cursor-pointer bg-white"
                                                style={{ fontSize: '16px' }}
                                            />
                                            <input
                                                id="reservationExpiryHidden"
                                                type="date"
                                                value={formData.reservationExpiry}
                                                onChange={(e) => handleChange('reservationExpiry', e.target.value)}
                                                className="absolute inset-0 opacity-0 pointer-events-none"
                                            />
                                            <div className="absolute right-8 top-3 pointer-events-none">
                                                <svg className="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 22 22">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                            </div>
                                            <p className="mt-1 text-xs text-gray-500">通常15日間有効</p>
                                            {formData.reservationExpiry && (
                                                <button
                                                    type="button"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        handleChange('reservationExpiry', '');
                                                    }}
                                                    className="absolute right-1 top-2.5 w-6 h-6 flex items-center justify-center text-gray-400 hover:text-red-600 hover:bg-red-50 rounded z-10"
                                                    title="クリア"
                                                >
                                                    <i className="fas fa-trash-alt text-xs"></i>
                                                </button>
                                            )}
                                        </div>
                                    </div>

                                    {/* カスタムMNP可能日 */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            📅 次回MNP可能日
                                        </label>
                                        <div className="relative">
                                            <input
                                                type="text"
                                                value={formData.customNextMNPDate ? formatDateWithWeekday(formData.customNextMNPDate) : ''}
                                                readOnly
                                                onClick={() => {
                                                    document.getElementById('customNextMNPDateHidden').focus();
                                                    document.getElementById('customNextMNPDateHidden').showPicker?.();
                                                }}
                                                placeholder="日付を選択してください"
                                                className="w-full px-3 py-2 pr-16 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent cursor-pointer bg-white"
                                                style={{ fontSize: '16px' }}
                                            />
                                            <input
                                                id="customNextMNPDateHidden"
                                                type="date"
                                                value={formData.customNextMNPDate}
                                                onChange={(e) => handleChange('customNextMNPDate', e.target.value)}
                                                className="absolute inset-0 opacity-0 pointer-events-none"
                                            />
                                            <div className="absolute right-8 top-3 pointer-events-none">
                                                <svg className="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 22 22">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                            </div>
                                            <p className="mt-1 text-xs text-gray-500">未設定の場合は契約日から180日後を自動計算</p>
                                            {formData.customNextMNPDate && (
                                                <button
                                                    type="button"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        handleChange('customNextMNPDate', '');
                                                    }}
                                                    className="absolute right-1 top-2.5 w-6 h-6 flex items-center justify-center text-gray-400 hover:text-red-600 hover:bg-red-50 rounded z-10"
                                                    title="クリア"
                                                >
                                                    <i className="fas fa-trash-alt text-xs"></i>
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* ログイン情報 */}
                                <div className="space-y-4">
                                    <h3 className="font-medium text-gray-900 border-b pb-2">ログイン情報</h3>
                                    
                                    {/* ログインID */}
                                    <div>
                                        <label className="block text-base font-medium text-gray-700 mb-1">
                                            👤 ログインID
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.loginId}
                                            onChange={(e) => handleChange('loginId', e.target.value)}
                                            placeholder="user@example.com"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            style={{ fontSize: '16px' }}
                                        />
                                    </div>

                                    {/* パスワード */}
                                    <div>
                                        <label className="block text-base font-medium text-gray-700 mb-1">
                                            🔒 パスワード
                                        </label>
                                        <div className="relative">
                                            <input
                                                type={showPassword ? "text" : "password"}
                                                value={formData.loginPassword}
                                                onChange={(e) => handleChange('loginPassword', e.target.value)}
                                                className="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                style={{ fontSize: '16px' }}
                                            />
                                            <button
                                                type="button"
                                                onClick={() => setShowPassword(!showPassword)}
                                                className="absolute right-3 top-2 text-gray-400 hover:text-gray-600"
                                            >
                                                <i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'}`}></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* メモ */}
                                <div className="space-y-4">
                                    <h3 className="font-medium text-gray-900 border-b pb-2">メモ</h3>
                                    
                                    <div>
                                        <label className="block text-base font-medium text-gray-700 mb-1">
                                            📝 メモ
                                        </label>
                                        <textarea
                                            value={formData.memo}
                                            onChange={(e) => handleChange('memo', e.target.value)}
                                            rows={3}
                                            placeholder="キャンペーン情報、注意事項等"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                            style={{ fontSize: '16px' }}
                                        />
                                    </div>
                                </div>

                                {/* 自動計算情報 */}
                                {nextMNPDate && (
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                        <h3 className="font-medium text-blue-900 mb-2">📊 自動計算情報</h3>
                                        <div className="text-sm text-blue-800 space-y-1">
                                            <p>次回MNP可能日: {formatDateWithWeekday(nextMNPDate)}</p>
                                            {formData.contractDate && (
                                                <p className="text-xs text-blue-600">
                                                    契約日から{Math.ceil((new Date(nextMNPDate) - new Date(formData.contractDate)) / (1000 * 60 * 60 * 24))}日後
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </form>
                        </div>

                        
                    </div>
                </div>
            );
        };
        // メインレンダリング
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>